---
title: "Tutorial"
author: "Michael Rustler"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Install R packages
```{r, eval = FALSE}
installed_packages <- rownames(installed.packages())

if(!"devtools" %in% installed_packages) {
  install.packages("devtools", repos = "https://cloud.r-project.org")
}
if(!"kwb.lca" %in% installed_packages) {
  devtools::install_github("KWB-R/kwb.lca")
}
```

# Load the R package kwb.lca
```{r, fig.show='hold'}
library(kwb.lca)
```

# Import data   

## Directory with example .csv files 

The example .csv files (in German format, i.e. decimals are indicated with `,` 
and `;` is used as field separator) are the Umberto model output files, which 
were stored in one zip file `Beispiel_Auswertung.zip` and attached to the R
package `kwb.lca` as shown below:

```{r}
zipfile <- system.file("extdata/Beispiel_Auswertung.zip", package = "kwb.lca")

temp <- file.path(tempdir(), "Beispiel_Auswertung")

unzip(zipfile, exdir = temp)

dir(temp, pattern = ".csv")
```

## Getting the data into R 

Using the function `kwb.lca::import_rawdata()` and specifying the parameter 
(here: `csv_dir` =  `r temp`) imports the model results from all four .csv files 
that are located in the folder `r temp`.  

```{r}
rawdata <- kwb.lca::import_rawdata(csv_dir = temp)
```

To access the structure of the imported data one can run the following command: 

```{r}
head(rawdata)
```

# Data aggregation

Once the data is imported into R, it can be aggregated as shown in the subsequent
subchapters.

## Grouping

```{r}
data_grouped <- kwb.lca::group_data(rawdata)
head(data_grouped)
```

## Making pivot data
```{r}
data_pivot <- kwb.lca::pivot_data(data_grouped)
head(data_pivot)
```

```{r}
data_pivot_list <- kwb.lca::create_pivot_list(data_pivot)
head(data_pivot)
```

# Data export

Finally the resulting data can be exported to an EXCEL spreatsheet. For each 
`lci_method` available in the imported dataset a sheet named `lci_method_1` to 
`lci_method_9` will be created, as there are 9 distinct `lci_method` available 
for this example data set: 

`r sprintf("\n- %s\n", unique(rawdata$lci_method))`


```{r}
export_path <- file.path(temp, "results.xlsx")
print(sprintf("Exporting aggregated results to %s", export_path))
write_xlsx(data_pivot_list, 
           path = export_path)
```           

# Data visualisation

In addition a simple visualisation of the imported and grouped data can 
be performed by calling the function `kwb.lca::plot_results()` as shown below:

```{r}
rawdata <- kwb.lca::import_rawdata(csv_dir = temp)
data_grouped <- kwb.lca::group_data(rawdata)
kwb.lca::plot_results(grouped_data = data_grouped)
```

